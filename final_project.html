<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cambridge Traffic Crash Map</title>
  <script src="https://d3js.org/d3.v4.min.js">
  </script> 
  <script src="https://unpkg.com/topojson@3"></script>

</head>
<style>
</style>

<body bgcolor="#fbfbf8">
  <h2>Cambridge Crash Data Report January to June 2016</h2>
  

    
      <svg id="map", width="800", height="500">
    <rect width="650", height="400" fill="#fbfbf8"></rect>
  </svg>
  <p>Select from the box to see the specific month's data</p>
      <select id="button" onchange="redraw(this.value)">
      <option value="all">All</option>
      <option value="01">January</option>
      <option value="02">Feburary</option>
      <option value="03">March</option>
      <option value="04">April</option>
      <option value="05">May</option>
      <option value="06">June</option>
      
    </select> 
    
   
  
</body>

<script>

  var redraw;

  

  



  function datafold(json) {
      return json.data.map(function(data){
        return json.meta.view.columns.reduce(function(obj, header, i){
          obj[header.name] = data[i];
          return obj;
        }, {});
      });
    }

    let dataSet = [];
    d3.queue()
      .defer(d3.json,"cambridge.geojson")
      .defer(d3.json, "cambridge crash data.json")
      .awaitAll(function(error,dataArray){
        if (error) console.log(error);
        var geoJSON = dataArray[0];
        dataSet = dataArray[1];
        
        var crashData = datafold(dataArray[1]).filter(function(d){
          return d.Longitude && d.Latitude;

        });
        
        crashData.forEach(function(d) {
          let a = new Date(d["Date Time"]);
          //elict the "Date Time" from the dataSet
          
          d.year = a.getFullYear(); //get the year
          d.month = a.getMonth(); //get the month

        });

      

        var years = Array.from(new Set(crashData.map(function(d) {
          return d.year;
        }))).sort();


        function getYear(prm){
          var check = false;
          for(var i = 0; i < years.length; i++) {
            if(years[i] == prm) {
              console.log("year: " + years[i] + " index: " + i);
              return i;
            }
          }
          return null;
        }  
        

        var oldestData = crashData.filter(function(d) {
          return d.year == 2016;
        });

        






        

        

        var proj = d3.geoAlbersUsa()
                     .fitSize([600,400], geoJSON);

        var path = d3.geoPath()
                     .projection(proj);

        var streets = d3.select("#map").selectAll("path")
                          .data(geoJSON.features);
        streets.enter().append("path")
               .attr("d", function(d){
                return path(d);
               })
               .attr("fill","lightgrey")
               .attr("stroke-width",1)
               .attr("stroke","lightblue")


        



        


        redraw = function(month) {



          if (month == "all") {
            var monthData = oldestData;
            
          }
          else {
            month = parseInt(month) - 1;
            var monthData = oldestData.filter(function(d) {
              return d.month == month;
            });
          }
          

          var circleUpdate = d3.select("#map").selectAll("circle")
           .data(monthData, function(d) {
            return d.sid;
           });


          var circleEnter = circleUpdate.enter().append("circle");

          circleUpdate.merge(circleEnter)
           .attr("transform", function(d){
            return "translate(" + proj([d.Longitude,d.Latitude]) + ")";
            })
           .attr("fill", "red")
           .attr("opacity", 0.4)
           .attr("r",5);

          circleUpdate.exit().remove();
      



          redraw("all");

      







</script>





</html>