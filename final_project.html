<!doctype html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>Cambridge Traffic Crash</title>
    <script src="https://d3js.org/d3.v4.min.js"></script> 
    <script src="https://unpkg.com/topojson@3"></script>
    <link href="https://fonts.googleapis.com/css?family=Gugi" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Abel" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet">
    <style>

      h1{
        font-family: 'Gugi', cursive;
        text-align: center;

      }
      h2{
        /*font-family: 'Abel', sans-serif;*/
        font-family: 'Gloria Hallelujah', cursive;
        text-transform: capitalize;      
        text-align: center;
        margin-top:0;
        color:#000000;
      }



      #area1 {
        display:inline-block;
        width: 600px;
        

      }
      #area2 {
        display: inline-block;
        vertical-align:top;
        width:500px;
        margin-left: 12%;


       
      
        
      }
    </style>
  </head>

  


  <body bgcolor="#fbfbf8">
    
    <h1>Cambridge Crash Data Jan-June,2016</h2>
    
    <div id="area1">
      <h2 class="left">Car Crash spots Distribution Map</h2>
      <svg id="map", width="600", height="400"></svg>
      
    </div>
    <div id="area2">
      <h2>Top ten most car crashes happened streets</h2>
      <svg id="bar", width="550", height="350"></svg>
      <p>Select from the box to see the specific month's data</p>
      <select id="button" onchange="redraw(this.value)">
        <option value="all">All</option>
        <option value="01">January</option>
        <option value="02">Feburary</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
       </select>
     </div>
     <div id="area3">
     </div>
    
  </body>


  <script>
    var redraw;
    
    
    function datafold(json) {
             return json.data.map(function(data){
               return json.meta.view.columns.reduce(function(obj, header, i){
                 obj[header.name] = data[i];
                   return obj;
                         },
                      {});
                    });
                  }

      


      let dataSet = [];
      d3.queue()
        .defer(d3.json,"cambridge.geojson")
        .defer(d3.json, "cambridge crash data.json")
        .awaitAll(function(error,dataArray){
          if (error) console.log(error);
            var geoJSON = dataArray[0];
            var crashData = datafold(dataArray[1]).filter(function(d){
              return d.Longitude && d.Latitude;
          });
          


      crashData.forEach(function(d) {
            let a = new Date(d["Date Time"]);
            d.year = a.getFullYear();
            d.month = a.getMonth();
        });

          

          var years = Array.from(new Set(crashData.map(function(d) {
                      return d.year;
                      }))).sort();


          function getYear(prm){
            var check = false;
            for(var i = 0; i < years.length; i++) {
              if(years[i] == prm) {
                console.log("year: " + years[i] + " index: " + i);
                return i;
              }
            }
            return null;
          }  
          

          var oldestData = crashData.filter(function(d) {
            return d.year == 2016;
          });

         







          

          

      var proj = d3.geoAlbersUsa()
                   .fitSize([600,400], geoJSON);

      var path = d3.geoPath()
                   .projection(proj);

      var streets = d3.select("#map").selectAll("path")
                      .data(geoJSON.features);
                      streets.enter().append("path")
                             .attr("d", function(d){
                              return path(d);
                             })
                             .attr("fill","lightgrey")
                             .attr("stroke-width",1)
                             .attr("stroke","lightblue")


          



          


        redraw = function(month) {

          if (month == "all") {
            var monthData = oldestData;
            
          }
          else {
            month = parseInt(month) - 1;
            var monthData = oldestData.filter(function(d) {
              return d.month == month;
            });
          }
          console.log(month, monthData);

          var circleUpdate = d3.select("#map").selectAll("circle")
           .data(monthData, function(d) {
            return d.sid;
           });

          var circleEnter = circleUpdate.enter().append("circle");

          circleUpdate.merge(circleEnter)
           .attr("transform", function(d){
            return "translate(" + proj([d.Longitude,d.Latitude]) + ")";
            })
           .attr("fill", "red")
           .attr("opacity", 0.4)
           .attr("r",5);

          circleUpdate.exit().remove();

          






          var StreetData = d3.nest()
            .key(function(d) {
              return d["Street Name"];
            })
            .entries(monthData)
            .sort(function(a, b) {
              return b.values.length - a.values.length;
            })
            .slice(0,10);
          
          console.log(StreetData);



          //Define ObjectData
          var crashObjects = monthData.reduce(function(acc, d) {
            acc.push(d["Object 1"]);
            acc.push(d["Object 2"]);
            return acc;
          }, []);

          var ObjectData = d3.nest()
            .key(function(d) {
              return d;
            })
            .entries(crashObjects)
            .sort(function(a, b) {
              return b.values.length - a.values.length;
            });

          console.log(ObjectData);






          //draw bar chart    
          var linearScale = d3.scaleLinear()
                             .domain([0,d3.max(StreetData,function(d){
                              return d.values.length;
                             })])
                             .range([0, 300]);
          
      
          var rectHeight = 35;
          
          

          var rects = d3.select("#bar").selectAll("rect")
                          .data(StreetData);
                          

          var rectsEnter = rects.enter().append("rect");


                           rects.merge(rectsEnter)
                                .attr("x",20)
                                .attr("y", function(d,i){
                                 
                                     return i * rectHeight;
                                    
                                  
                                  
                                })
                                .attr("width", function(d){
                                  return linearScale(d.values.length); 
                                })
                                .attr("height", rectHeight-4)
                                .attr("fill", "#b3002d")
                                .attr('transform','translate(170,0)');


           

          


          //add numbers beside chart                  
          var texts = d3.select("#bar").selectAll("text.label")
                       .data(StreetData);


          var textsEnter = texts.enter().append("text")
            .attr("class", "label");

                    texts.merge(textsEnter)                      
                         .text(function(d){
                          return d.key;
                         })
                         .attr("x", 5)
                         .attr("y", function(d,i){
                          
                            return i * rectHeight;

                            
                          })
                         .attr("dy",22)                       
                         .attr('transform','translate(0,0)');








          

          var values = d3.select("#bar").selectAll("text.value")
                       .data(StreetData);


          var valuesEnter = values.enter().append("text")
            .attr("class", "value");

          values.merge(valuesEnter) 
            .text(function(d){
                console.log(d.values.length);
                return d.values.length;
               })
            .attr("x",function(d){
                return linearScale(d.values.length) + 30;
               })                                                  
            .attr("y", function(d,i){                               
                return i * rectHeight -6;                      
             })
            .attr("dy",22)
            .attr('transform','translate(170,6)');           
            
          };// bar logic goes here




        



        
        
        // var dataset = [
        //   { label: 'Abulia', count: 10 },
        //   { label: 'Betelgeuse', count: 20 },
        //   { label: 'Cantaloupe', count: 30 },
        //   { label: 'Dijkstra', count: 40 }
        // ];
      //   var width = 360;
      //   var height = 360;
      //   var radius = Math.min(width, height) / 2;
      //   var donutWidth = 75;// NEW
      //   var color = d3.scaleOrdinal(d3.schemeCategory20b);
      //   var svg = d3.select('#area3')
      //               .append('svg')
      //               .attr('width', width)
      //               .attr('height', height)
      //               .append('g')
      //               .attr('transform', 'translate(' + (width / 2) +
      //                 ',' + (height / 2) + ')');
      //   var arc = d3.arc()
      //     .innerRadius(radius - donutWidth)// UPDATED
      //     .outerRadius(radius);
      //   var pie = d3.pie()
      //     .value(function(d) { return d.count; })
      //     .sort(null);
      //   var path = svg.selectAll('path')
      //     .data(pie(ObjectData))
      //     .enter()
      //     .append('path')
      //     .attr('d', arc)
      //     .attr('fill', function(d, i) {
      //       return color(d.data.label);
      //     });
      // (window.d3);













        


          redraw("all");
          rects.exit().remove();
          texts.exit().remove();
          numbersEnter.exit().remove();
          

          



          



                      







          });













                  










          
          

  </script>





  </html>